#!/bin/bash
#
# kebab-rename-safe - Think Hard before renaming
# å®‰å…¨å¢å¼·ç‰ˆçš„ kebab-rename wrapper
#
# åŠŸèƒ½ï¼š
#   - è©³ç´°çµ±è¨ˆåˆ†æ
#   - è‡ªå‹•å‚™ä»½æª”åå°ç…§è¡¨
#   - äºŒæ¬¡ç¢ºèªæ©Ÿåˆ¶
#   - æ”¯æ´ undo å›æ»¾
#

set -e

# é¡è‰²å®šç¾©
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# å–å¾—è…³æœ¬æ‰€åœ¨ç›®éŒ„
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
KEBAB_RENAME="$SCRIPT_DIR/kebab-rename.js"

# æ­·å²è¨˜éŒ„ç›®éŒ„
HISTORY_DIR=".kebab-rename-history"

# é¡¯ç¤ºä½¿ç”¨èªªæ˜
show_help() {
    echo ""
    echo -e "${CYAN}kebab-rename-safe${NC} - Think Hard before renaming"
    echo ""
    echo "ç”¨æ³•ï¼š"
    echo "  kebab-rename-safe [ç›®éŒ„] [é¸é …]"
    echo ""
    echo "é¸é …ï¼š"
    echo "  -r, --recursive    éè¿´è™•ç†å­ç›®éŒ„"
    echo "  -s, --style        å‘½åé¢¨æ ¼ (kebab æˆ– camel)ï¼Œé è¨­ kebab"
    echo "  -e, --ext          åªè™•ç†ç‰¹å®šå‰¯æª”åï¼Œé€—è™Ÿåˆ†éš”"
    echo "  -f, --force        è·³éç¢ºèªç›´æ¥åŸ·è¡Œï¼ˆä»æœƒå‚™ä»½ï¼‰"
    echo "  --undo             å›æ»¾ä¸Šæ¬¡æ“ä½œ"
    echo "  --history          é¡¯ç¤ºæ“ä½œæ­·å²"
    echo "  -h, --help         é¡¯ç¤ºæ­¤èªªæ˜"
    echo ""
    echo "ç¯„ä¾‹ï¼š"
    echo "  kebab-rename-safe ./src -r                    # é è¦½ä¸¦ç¢ºèª"
    echo "  kebab-rename-safe ./src -r -s camel           # ä½¿ç”¨ camelCase"
    echo "  kebab-rename-safe ./src -r -f                 # è·³éç¢ºèª"
    echo "  kebab-rename-safe --undo                      # å›æ»¾ä¸Šæ¬¡æ“ä½œ"
    echo ""
}

# é¡¯ç¤ºæ“ä½œæ­·å²
show_history() {
    if [[ ! -d "$HISTORY_DIR" ]]; then
        echo -e "${YELLOW}å°šç„¡æ“ä½œæ­·å²${NC}"
        return
    fi

    echo ""
    echo -e "${CYAN}=== æ“ä½œæ­·å² ===${NC}"
    echo ""

    local count=0
    for file in "$HISTORY_DIR"/*.json; do
        [[ -e "$file" ]] || continue
        count=$((count + 1))

        local basename=$(basename "$file" .json)
        local timestamp=$(echo "$basename" | sed 's/_/ /; s/-/:/3; s/-/:/3')
        local items=$(grep -c '"oldPath"' "$file" 2>/dev/null || echo "0")
        local style=$(grep -o '"style":"[^"]*"' "$file" | head -1 | cut -d'"' -f4)

        echo -e "  ${GREEN}[$count]${NC} $timestamp"
        echo -e "      é¢¨æ ¼: ${BLUE}$style${NC}, é …ç›®æ•¸: ${YELLOW}$items${NC}"
        echo ""
    done

    if [[ $count -eq 0 ]]; then
        echo -e "${YELLOW}å°šç„¡æ“ä½œæ­·å²${NC}"
    fi
}

# åŸ·è¡Œ undo
do_undo() {
    if [[ ! -d "$HISTORY_DIR" ]]; then
        echo -e "${RED}éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°æ­·å²è¨˜éŒ„ç›®éŒ„${NC}"
        exit 1
    fi

    # æ‰¾åˆ°æœ€æ–°çš„æ­·å²æª”æ¡ˆ
    local latest=$(ls -t "$HISTORY_DIR"/*.json 2>/dev/null | head -1)

    if [[ -z "$latest" ]]; then
        echo -e "${RED}éŒ¯èª¤ï¼šæ²’æœ‰å¯å›æ»¾çš„æ“ä½œ${NC}"
        exit 1
    fi

    echo ""
    echo -e "${CYAN}=== Think Hard: å›æ»¾ç¢ºèª ===${NC}"
    echo ""
    echo -e "æº–å‚™å›æ»¾: ${YELLOW}$(basename "$latest")${NC}"
    echo ""

    # è§£æä¸¦é¡¯ç¤ºå°‡è¦å›æ»¾çš„é …ç›®
    echo -e "${BLUE}å°‡è¦é‚„åŸçš„é …ç›®ï¼š${NC}"
    echo ""

    # ä½¿ç”¨ node è§£æ JSONï¼ˆæ›´å¯é ï¼‰
    node -e "
        const fs = require('fs');
        const data = JSON.parse(fs.readFileSync('$latest', 'utf8'));

        console.log('  é¢¨æ ¼: ' + data.style);
        console.log('  ç›®éŒ„: ' + data.targetDir);
        console.log('  é …ç›®æ•¸: ' + data.items.length);
        console.log('');

        data.items.slice(0, 10).forEach(item => {
            const icon = item.isDirectory ? 'ğŸ“‚' : 'ğŸ“„';
            console.log('  ' + icon + ' ' + item.newName + '  â†’  ' + item.oldName);
        });

        if (data.items.length > 10) {
            console.log('  ... é‚„æœ‰ ' + (data.items.length - 10) + ' å€‹é …ç›®');
        }
    "

    echo ""
    echo -e "${YELLOW}âš ï¸  ç¢ºå®šè¦å›æ»¾å—ï¼Ÿæ­¤æ“ä½œæœƒå°‡æª”åé‚„åŸç‚ºåŸå§‹åç¨±ã€‚${NC}"
    echo ""
    read -p "è¼¸å…¥ 'yes' ç¢ºèªå›æ»¾: " confirm

    if [[ "$confirm" != "yes" ]]; then
        echo -e "${YELLOW}å·²å–æ¶ˆå›æ»¾${NC}"
        exit 0
    fi

    echo ""
    echo -e "${BLUE}ğŸ”„ åŸ·è¡Œå›æ»¾...${NC}"
    echo ""

    # åŸ·è¡Œå›æ»¾
    local result=$(node -e "
        const fs = require('fs');
        const data = JSON.parse(fs.readFileSync('$latest', 'utf8'));

        let success = 0;
        let failed = 0;
        const errors = [];

        // åå‘åŸ·è¡Œï¼ˆå› ç‚ºåŸæœ¬æ˜¯æ·±åº¦å„ªå…ˆï¼Œå›æ»¾è¦æ·ºå±¤å„ªå…ˆï¼‰
        const items = data.items.reverse();

        for (const item of items) {
            try {
                if (fs.existsSync(item.newPath)) {
                    fs.renameSync(item.newPath, item.oldPath);
                    success++;
                } else {
                    failed++;
                    errors.push(item.newPath + ': æª”æ¡ˆä¸å­˜åœ¨');
                }
            } catch (err) {
                failed++;
                errors.push(item.newPath + ': ' + err.message);
            }
        }

        console.log(JSON.stringify({ success, failed, errors }));
    ")

    local success=$(echo "$result" | node -e "const d=JSON.parse(require('fs').readFileSync(0,'utf8')); console.log(d.success)")
    local failed=$(echo "$result" | node -e "const d=JSON.parse(require('fs').readFileSync(0,'utf8')); console.log(d.failed)")

    if [[ "$success" -gt 0 ]]; then
        echo -e "${GREEN}âœ… æˆåŠŸé‚„åŸ $success å€‹é …ç›®${NC}"
    fi

    if [[ "$failed" -gt 0 ]]; then
        echo -e "${RED}âŒ å¤±æ•— $failed å€‹é …ç›®${NC}"
    fi

    # åˆªé™¤å·²ä½¿ç”¨çš„æ­·å²æª”æ¡ˆ
    rm "$latest"
    echo ""
    echo -e "${GREEN}å›æ»¾å®Œæˆï¼Œæ­·å²è¨˜éŒ„å·²æ¸…é™¤${NC}"
}

# è§£æé è¦½è¼¸å‡ºä¸¦é¡¯ç¤ºçµ±è¨ˆ
analyze_preview() {
    local preview="$1"
    local style="$2"

    echo ""
    echo -e "${CYAN}=== Think Hard: è©³ç´°åˆ†æ ===${NC}"
    echo ""

    # è¨ˆç®—æª”æ¡ˆå’Œç›®éŒ„æ•¸é‡
    local dir_count=$(echo "$preview" | grep -c "ğŸ“‚" || echo "0")
    local file_count=$(echo "$preview" | grep -c "ğŸ“„" || echo "0")
    local total=$((dir_count + file_count))

    if [[ $total -eq 0 ]]; then
        echo -e "${GREEN}âœ“ æ‰€æœ‰æª”åéƒ½å·²ç¶“æ˜¯ç›®æ¨™æ ¼å¼ï¼Œä¸éœ€è¦è®Šæ›´ã€‚${NC}"
        return 1
    fi

    # é¡¯ç¤ºçµ±è¨ˆ
    echo -e "${BLUE}ğŸ“Š è®Šæ›´çµ±è¨ˆï¼š${NC}"
    echo -e "   ç›®éŒ„: ${YELLOW}$dir_count${NC} å€‹"
    echo -e "   æª”æ¡ˆ: ${YELLOW}$file_count${NC} å€‹"
    echo -e "   ç¸½è¨ˆ: ${YELLOW}$total${NC} å€‹é …ç›®"
    echo ""

    # åˆ†æå‰¯æª”ååˆ†ä½ˆ
    echo -e "${BLUE}ğŸ“ å‰¯æª”ååˆ†ä½ˆï¼š${NC}"
    echo "$preview" | grep "ğŸ“„" | grep -oE '\.[a-zA-Z0-9]+$' | sort | uniq -c | sort -rn | head -10 | while read count ext; do
        echo -e "   $ext: ${YELLOW}$count${NC}"
    done
    echo ""

    # é¡¯ç¤ºå‘½åé¢¨æ ¼
    local style_label
    if [[ "$style" == "camel" ]]; then
        style_label="camelCase"
    else
        style_label="kebab-case"
    fi
    echo -e "${BLUE}ğŸ¨ ç›®æ¨™é¢¨æ ¼ï¼š${NC} ${GREEN}$style_label${NC}"
    echo ""

    return 0
}

# å‚™ä»½åˆ°æ­·å²è¨˜éŒ„ï¼ˆç›´æ¥èª¿ç”¨ scanDirectory å–å¾—å®Œæ•´è·¯å¾‘ï¼‰
save_history() {
    local target_dir="$1"
    local style="$2"
    local recursive="$3"
    local extensions="$4"

    mkdir -p "$HISTORY_DIR"

    local timestamp=$(date +"%Y-%m-%d_%H-%M-%S")
    local history_file="$HISTORY_DIR/${timestamp}.json"

    # ç›´æ¥ä½¿ç”¨ scanDirectory å–å¾—å®Œæ•´è·¯å¾‘è³‡è¨Š
    node -e "
        const { scanDirectory } = require('$SCRIPT_DIR/../src/index.js');
        const fs = require('fs');

        const targetDir = '$target_dir';
        const style = '$style';
        const recursive = '$recursive' === '-r';
        const extStr = '$extensions'.replace('-e ', '').trim();
        const extensions = extStr ? extStr.split(',').map(e => e.trim()).filter(Boolean).map(e => e.startsWith('.') ? e.toLowerCase() : '.' + e.toLowerCase()) : [];

        const items = scanDirectory(targetDir, { recursive, extensions, style });

        const result = {
            timestamp: '$timestamp',
            targetDir,
            style,
            items: items.map(item => ({
                oldPath: item.oldPath,
                newPath: item.newPath,
                oldName: item.oldName,
                newName: item.newName,
                isDirectory: item.isDirectory
            }))
        };

        fs.writeFileSync('$history_file', JSON.stringify(result, null, 2));
    "

    echo "$history_file"
}

# ä¸»ç¨‹å¼
main() {
    local target_dir="."
    local recursive=""
    local style="kebab"
    local extensions=""
    local force=false

    # è§£æåƒæ•¸
    while [[ $# -gt 0 ]]; do
        case $1 in
            -h|--help)
                show_help
                exit 0
                ;;
            --undo)
                do_undo
                exit 0
                ;;
            --history)
                show_history
                exit 0
                ;;
            -r|--recursive)
                recursive="-r"
                shift
                ;;
            -s|--style)
                style="$2"
                shift 2
                ;;
            -e|--ext)
                extensions="-e $2"
                shift 2
                ;;
            -f|--force)
                force=true
                shift
                ;;
            -*)
                echo -e "${RED}æœªçŸ¥é¸é …: $1${NC}"
                show_help
                exit 1
                ;;
            *)
                target_dir="$1"
                shift
                ;;
        esac
    done

    # é©—è­‰ style
    if [[ "$style" != "kebab" && "$style" != "camel" ]]; then
        echo -e "${RED}éŒ¯èª¤ï¼šä¸æ”¯æ´çš„å‘½åé¢¨æ ¼ '$style'${NC}"
        echo "è«‹ä½¿ç”¨ 'kebab' æˆ– 'camel'"
        exit 1
    fi

    # é©—è­‰ç›®æ¨™ç›®éŒ„
    if [[ ! -d "$target_dir" ]]; then
        echo -e "${RED}éŒ¯èª¤ï¼šç›®éŒ„ä¸å­˜åœ¨ '$target_dir'${NC}"
        exit 1
    fi

    target_dir=$(cd "$target_dir" && pwd)

    echo ""
    echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${CYAN}â•‘     ğŸ§  Think Hard Before Rename      â•‘${NC}"
    echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"

    # åŸ·è¡Œ dry-run å–å¾—é è¦½
    echo ""
    echo -e "${BLUE}ğŸ” æƒæä¸­...${NC}"

    local preview
    preview=$(node "$KEBAB_RENAME" "$target_dir" $recursive $extensions -s "$style" --dry-run 2>&1)

    # é¡¯ç¤ºåŸå§‹é è¦½
    echo "$preview" | grep -E "(ğŸ“‚|ğŸ“„|â†’)" | head -20

    local total_items=$(echo "$preview" | grep -cE "(ğŸ“‚|ğŸ“„)" || echo "0")
    if [[ $total_items -gt 20 ]]; then
        echo -e "  ${YELLOW}... é‚„æœ‰ $((total_items - 20)) å€‹é …ç›®${NC}"
    fi

    # åˆ†æä¸¦é¡¯ç¤ºçµ±è¨ˆ
    if ! analyze_preview "$preview" "$style"; then
        exit 0
    fi

    # å‚™ä»½æ­·å²
    echo -e "${BLUE}ğŸ’¾ å»ºç«‹å‚™ä»½è¨˜éŒ„...${NC}"
    local history_file
    history_file=$(save_history "$target_dir" "$style" "$recursive" "$extensions")
    echo -e "   å·²å„²å­˜è‡³: ${GREEN}$history_file${NC}"
    echo ""

    # ç¢ºèªåŸ·è¡Œ
    if [[ "$force" == true ]]; then
        echo -e "${YELLOW}âš¡ Force æ¨¡å¼ï¼šè·³éç¢ºèª${NC}"
    else
        echo -e "${YELLOW}âš ï¸  å³å°‡é‡æ–°å‘½å $total_items å€‹é …ç›®${NC}"
        echo ""
        echo -e "è¼¸å…¥ ${GREEN}'yes'${NC} ç¢ºèªåŸ·è¡Œï¼Œæˆ–æŒ‰ Enter å–æ¶ˆï¼š"
        read -p "> " confirm

        if [[ "$confirm" != "yes" ]]; then
            echo ""
            echo -e "${YELLOW}å·²å–æ¶ˆæ“ä½œ${NC}"
            echo -e "æç¤ºï¼šä½¿ç”¨ ${CYAN}kebab-rename-safe --undo${NC} å¯å›æ»¾ä¸Šæ¬¡æ“ä½œ"
            # åˆªé™¤å‰›å»ºç«‹çš„æ­·å²æª”æ¡ˆï¼ˆå› ç‚ºæ²’æœ‰åŸ·è¡Œï¼‰
            rm -f "$history_file"
            exit 0
        fi
    fi

    # åŸ·è¡Œé‡å‘½å
    echo ""
    echo -e "${BLUE}ğŸš€ åŸ·è¡Œé‡æ–°å‘½å...${NC}"
    echo ""

    node "$KEBAB_RENAME" "$target_dir" $recursive $extensions -s "$style" --yes

    echo ""
    echo -e "${GREEN}âœ… å®Œæˆï¼${NC}"
    echo -e "æç¤ºï¼šä½¿ç”¨ ${CYAN}kebab-rename-safe --undo${NC} å¯å›æ»¾æ­¤æ“ä½œ"
    echo ""
}

main "$@"
